MY_VIRTUALENV_NAMES=${MY_VIRTUALENV_NAMES:-.venv}

function find_dir_in_parents() {
    local needle=$1
    test -n "$needle" || return
    local look=$( readlink --canonicalize ${2:-.} )
    test -d "$look" || return
    local needle_dir=$( dirname "$needle" )
    while [ "$( dirname "$look" )" != "$look" ]
    do
        if [ "$( builtin cd "$look"; readlink --canonicalize $needle_dir )" = "$look" ]
        then
            local candidate=$look/${needle#$look/}
            test -d "$candidate" && echo $candidate && break
        fi
        look=$( dirname "$look" )
    done
}

function switch_virtualenvs() {
    local new="$1"
    [ "$VIRTUAL_ENV" = "$new" ] && return
    [ -n "${VIRTUAL_ENV+virtualenv active}" ] && deactivate
    local activate="$new/bin/activate"
    test -e "$activate" && source "$activate"
    true
}

function detect_virtualenv() {
    local names=${1:-$MY_VIRTUALENV_NAMES}
    IFS=':' read -ra dirs <<< "$VIRTUAL_ENV:$names"
    local found
    for dir in "${dirs[@]}"
    do
        local found=$( find_dir_in_parents "$dir" )
        [ -n "$found" ] && break
    done
    switch_virtualenvs "$found"
}

function detect_virtualenv_on_prompt() {
  if [ "${PROMPT_COMMAND/detect_virtualenv//}" = "$PROMPT_COMMAND" ] ; then
    export PROMPT_COMMAND="detect_virtualenv${PROMPT_COMMAND:+;$PROMPT_COMMAND}"
  fi
}

if [ $# -gt 0 ]
then
  case $1 in
    on_prompt) shift; detect_virtualenv_on_prompt ;;
  esac
fi

if [ $# -gt 0 ]
then
  echo detect_virtualenv: ignoring unknown parameters: $@ >&2
fi

# vim: ft=sh
